# Environment Variables Management Guide

## Overview

This document describes the centralized environment variable management system for the Event Horizon application. This system ensures consistent, secure, and maintainable configuration across all services.

## Architecture

### Core Principles

1. **Single Source of Truth**: All environment variables are defined in root-level `.env` files
2. **Environment Separation**: Clear distinction between development, testing, and production
3. **Security First**: Sensitive values are never committed to version control
4. **Validation**: Required variables are validated before service startup
5. **Consistency**: All services use the same environment configuration pattern

## File Structure

```
/
├── .env.example              # Template with all variables and documentation
├── .env.development          # Development environment (gitignored)
├── .env.production           # Production environment (gitignored, create when needed)
├── .gitignore                # Ensures .env files are not committed
├── docker-compose.yml        # References .env files via env_file directive
└── scripts/
    └── validate-env.sh       # Validates environment configuration
```

## Environment Files

### `.env.example`

The template file containing:
- All available environment variables
- Documentation for each variable
- Placeholder values
- Notes about required external services

**This file IS committed to version control** and serves as documentation.

### `.env.development`

Contains sensible defaults for local development:
- Pre-configured database credentials
- Development API keys (placeholder)
- Local service URLs
- Debug-friendly settings

**This file IS committed to version control** for developer convenience, but contains no real secrets.

### `.env.production`

Production environment configuration:
- Secure credentials
- Production API keys
- Production service URLs
- Optimized settings

**This file is NEVER committed to version control** and must be created manually or via deployment automation.

## Getting Started

### Initial Setup

1. **Review the example file**:
   ```bash
   cat .env.example
   ```

2. **The `.env.development` file is already created** with sensible defaults for local development

3. **Update secrets** (if needed for your local environment):
   ```bash
   # Edit .env.development to add your Discord bot token, API keys, etc.
   nano .env.development
   ```

4. **Validate configuration**:
   ```bash
   ./scripts/validate-env.sh
   ```

5. **Start services**:
   ```bash
   docker-compose up -d
   ```

### For Production Deployment

1. **Create production environment file**:
   ```bash
   cp .env.example .env.production
   ```

2. **Fill in production values**:
   ```bash
   nano .env.production
   # Update all placeholder values with production credentials
   ```

3. **Update docker-compose.yml** to reference `.env.production`:
   ```yaml
   env_file:
     - .env.production
   ```

4. **Validate and deploy**:
   ```bash
   ./scripts/validate-env.sh
   docker-compose up -d
   ```

## Variable Categories

### Database Configuration

Variables for PostgreSQL database:
- `POSTGRES_DB`: Database name
- `POSTGRES_USER`: Database user
- `POSTGRES_PASSWORD`: Database password
- `POSTGRES_HOST`: Database host (usually `postgres` in Docker)
- `POSTGRES_PORT`: Database port (default: 5432)
- `DATABASE_URL`: Full connection string

### Service Ports

Port configurations for each service:
- `BACKEND_PORT`: Backend API port (default: 8000)
- `FRONTEND_PORT`: Frontend dev server port (default: 5173)
- `N8N_PORT`: n8n automation port (default: 5678)
- `DISCORD_BOT_PORT`: Discord bot HTTP port (default: 54545)

### n8n Configuration

n8n automation platform settings:
- `N8N_INSTANCE_ID`: Unique instance identifier
- `N8N_API_KEY`: API key for n8n endpoints
- `N8N_BASE_URL`: Base URL for n8n instance
- Various credential IDs (generated by n8n)

### External API Credentials

Third-party service credentials:
- `DISCORD_BOT_TOKEN`: Discord bot authentication token
- `GOOGLE_CLIENT_ID`: Google OAuth client ID
- `OPENROUTER_API_KEY`: OpenRouter API key
- `PERPLEXITY_API_KEY`: Perplexity API key
- `SMTP_*`: Email service credentials

## Service Configuration

### How Services Access Variables

All services are configured in [`docker-compose.yml`](../docker-compose.yml) to use the `env_file` directive:

```yaml
services:
  backend:
    env_file:
      - .env.development
    # Service can now access all variables from .env.development
```

### Service-Specific Variables

While most variables come from the root `.env` file, some services maintain additional configuration:

- **n8n**: Maintains `/n8n/.env` for workflow-specific credential IDs (generated by sanitize script)
- This file is mounted as a volume for n8n's internal use

## Validation Script

The [`validate-env.sh`](../scripts/validate-env.sh) script ensures all required variables are set:

```bash
./scripts/validate-env.sh
```

**Features**:
- Checks if `.env.development` exists
- Validates all required variables are set
- Warns about missing optional variables
- Provides clear error messages
- Exit code 0 on success, 1 on failure

**Usage in CI/CD**:
```bash
# In your deployment pipeline
./scripts/validate-env.sh || exit 1
docker-compose up -d
```

## Security Best Practices

### DO ✅

1. **Always use strong, unique passwords** for production
2. **Rotate credentials regularly**
3. **Use secret management tools** (AWS Secrets Manager, HashiCorp Vault) in production
4. **Validate environment** before deployment
5. **Keep `.env.example` up-to-date** with new variables
6. **Review `.gitignore`** to ensure secrets aren't committed

### DON'T ❌

1. **Never commit actual `.env.production`** to version control
2. **Never hardcode secrets** in source code
3. **Never share credentials** via insecure channels
4. **Never use development credentials** in production
5. **Never expose environment files** in public repositories

## Troubleshooting

### Common Issues

#### "Environment file not found"

```bash
# Solution: Copy from example
cp .env.example .env.development
```

#### "Variable not set" errors

```bash
# Solution: Run validation to see what's missing
./scripts/validate-env.sh
```

#### Service can't access variables

1. Check `docker-compose.yml` has `env_file` directive
2. Verify file path is correct (relative to docker-compose.yml)
3. Ensure variable is exported in the .env file
4. Restart services: `docker-compose restart`

#### Variables not updating

```bash
# Recreate containers to reload environment
docker-compose down
docker-compose up -d
```

## Migrating from Old Pattern

If you have existing services using different environment patterns:

1. **Identify current variables** in docker-compose.yml
2. **Add them to `.env.development`**
3. **Update docker-compose.yml** to use `env_file`
4. **Remove hardcoded values** from docker-compose.yml
5. **Remove `.env` copies** from Dockerfiles
6. **Test thoroughly** to ensure nothing breaks
7. **Update documentation**

## Advanced Usage

### Multiple Environment Files

You can layer environment files for flexibility:

```yaml
services:
  backend:
    env_file:
      - .env.development        # Base configuration
      - .env.local              # Local overrides (gitignored)
      - ./backend/.env.backend  # Service-specific
```

Variables in later files override earlier ones.

### Variable Substitution

Docker Compose supports variable substitution:

```yaml
ports:
  - "${BACKEND_PORT:-8000}:8000"  # Use BACKEND_PORT or default to 8000
```

### Conditional Environments

Use different compose files for different environments:

```bash
# Development
docker-compose -f docker-compose.yml up

# Production
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
```

## Maintenance

### Adding New Variables

1. **Add to `.env.example`** with documentation
2. **Add to `.env.development`** with default value
3. **Update validation script** if variable is required
4. **Update this documentation**
5. **Notify team members** to update their local environments

### Removing Variables

1. **Remove from all `.env` files**
2. **Remove from validation script**
3. **Update documentation**
4. **Check for usage** in source code and docker-compose.yml

## References

- [Docker Compose Environment Variables](https://docs.docker.com/compose/environment-variables/)
- [12-Factor App Configuration](https://12factor.net/config)
- [OWASP Secrets Management](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)

## Support

For questions or issues:
1. Check this documentation
2. Run `./scripts/validate-env.sh` for validation
3. Review `.env.example` for variable descriptions
4. Check service logs: `docker-compose logs <service-name>`